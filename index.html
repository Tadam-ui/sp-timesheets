<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SP Timesheets</title>
<style>
body{
font-family:Arial, sans-serif;
background:linear-gradient(135deg,#ff6b6b,#ff8787);
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
margin:0;
padding:20px;
}
.app{
background:white;
padding:30px;
border-radius:20px;
width:100%;
max-width:400px;
text-align:center;
box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.logo{
width:80px;
height:80px;
background:#dc3545;
border-radius:50%;
margin:0 auto 20px;
display:flex;
align-items:center;
justify-content:center;
font-size:36px;
font-weight:700;
color:white;
}
h2{
margin:10px 0 20px;
color:#2c3e50;
}
h3{
color:#2c3e50;
}
/* LOGIN SCREEN */
.login-input{
width:100%;
padding:15px;
margin:10px 0;
border-radius:12px;
font-size:16px;
border:2px solid #e0e0e0;
box-sizing:border-box;
}
.login-input:focus{
outline:none;
border-color:#dc3545;
}
.login-btn{
width:100%;
padding:15px;
background:#dc3545;
color:white;
border:none;
border-radius:12px;
font-size:16px;
font-weight:600;
cursor:pointer;
margin-top:10px;
}
.login-btn:hover{
background:#c82333;
}
.help-text{
color:#7f8c8d;
font-size:14px;
margin-top:15px;
}
/* MAIN APP */
button{
padding:12px 20px;
border:none;
border-radius:30px;
cursor:pointer;
margin:8px;
font-size:16px;
font-weight:600;
}
.clock-in{
background:#2ecc71;
color:white;
padding:40px;
width:180px;
height:180px;
border-radius:50%;
font-size:20px;
margin:20px auto;
display:flex;
align-items:center;
justify-content:center;
flex-direction:column;
}
.clock-out{
background:#e74c3c;
color:white;
padding:40px;
width:180px;
height:180px;
border-radius:50%;
font-size:20px;
margin:20px auto;
}
.logout-btn{
background:#6c757d;
color:white;
padding:8px 16px;
font-size:14px;
}
textarea{
width:100%;
height:80px;
padding:12px;
border:2px solid #e0e0e0;
border-radius:8px;
font-size:14px;
margin:10px 0;
font-family:Arial;
box-sizing:border-box;
}
.view-btn{
background:#00bcd4;
color:white;
padding:12px 24px;
}
table{
width:100%;
font-size:12px;
margin-top:15px;
border-collapse:collapse;
}
td,th{
border-bottom:1px solid #ddd;
padding:8px 4px;
text-align:left;
}
th{
background:#f5f5f5;
font-weight:600;
}
input.table-input{
width:100%;
font-size:11px;
padding:4px;
border:1px solid #ddd;
border-radius:4px;
}
.today-hours{
font-size:18px;
color:#2c3e50;
margin:15px 0;
font-weight:600;
}
.hidden{
display:none;
}
.error{
color:#e74c3c;
background:#ffe5e5;
padding:10px;
border-radius:8px;
margin:10px 0;
font-size:14px;
}
</style>
</head>
<body>
<div class="app">
<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
<div class="logo">SP</div>
<h2>SP Timesheets</h2>
<p class="help-text">Enter your 4-digit PIN</p>
<input type="tel" 
       id="pinInput" 
       class="login-input" 
       placeholder="Enter PIN (e.g., 1234)" 
       maxlength="4"
       pattern="[0-9]*"
       inputmode="numeric">
<button class="login-btn" onclick="app.login()">Login</button>
<div id="errorMsg" class="error hidden"></div>
<p class="help-text" style="margin-top:25px;">Enter your personal 4-digit PIN to access your timesheet.</p>
</div>

<!-- MAIN APP SCREEN -->
<div id="mainScreen" class="hidden">
<div class="logo">SP</div>
<h2>SP Timesheets</h2>
<h3 id="name"></h3>
<button class="logout-btn" onclick="app.logout()">Logout</button>
<p class="today-hours">Today: <span id="today">0:00</span></p>
<button id="clockBtn" class="clock-in" onclick="app.toggleClock()">
<span id="clockText">⏱️<br>Clock In</span>
</button>
<textarea id="notes" placeholder="Job notes (e.g., £250 bonus, night work, etc.)"></textarea>
<button class="view-btn" onclick="app.toggleTable()">View My Timesheet</button>
<div id="tableWrap" class="hidden">
<h4 style="margin-top:20px;">My Recent Entries</h4>
<table>
<thead>
<tr>
<th>Date</th>
<th>Start</th>
<th>End</th>
<th>Hrs</th>
<th>Notes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>
</div>

<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvRWVHRf_diTDdZ8qp_RPXj4n97SZNb5ePPuALqdBWgH0L1KOxN3UzoYif2Ly5eiOy-Q/exec';

// EMPLOYEE DATABASE WITH PINS
const EMPLOYEES = {
'1234': { name: 'Dan Halpin', pin: '1234' },
'5678': { name: 'Paul Read', pin: '5678' },
'9012': { name: 'Devris Hudaverdi', pin: '9012' },
'3456': { name: 'Shane Clark', pin: '3456' },
'7890': { name: 'Jack Saillart', pin: '7890' },
'2468': { name: 'John Tomlin', pin: '2468' }
};

class Timesheet{
constructor(){
this.user = null;
this.entry = null;
this.timer = null;
this.history = [];
// Check if user is already logged in
const savedUser = localStorage.getItem('currentUser');
if(savedUser){
this.user = JSON.parse(savedUser);
this.loadHistory();
this.showMainScreen();
}
}

/* LOGIN WITH PIN */
login(){
const pin = document.getElementById('pinInput').value.trim();
const errorMsg = document.getElementById('errorMsg');

// Validate PIN
if(!pin || pin.length !== 4){
errorMsg.textContent = '⚠️ Please enter a 4-digit PIN';
errorMsg.classList.remove('hidden');
return;
}

// Check if PIN exists
const employee = EMPLOYEES[pin];
if(!employee){
errorMsg.textContent = '❌ Invalid PIN. Please try again.';
errorMsg.classList.remove('hidden');
document.getElementById('pinInput').value = '';
return;
}

// Success!
this.user = employee;
localStorage.setItem('currentUser', JSON.stringify(this.user));
this.loadHistory();
this.showMainScreen();
errorMsg.classList.add('hidden');
document.getElementById('pinInput').value = '';
}

logout(){
if(confirm('Are you sure you want to logout?')){
localStorage.removeItem('currentUser');
this.user = null;
this.history = [];
if(this.timer) clearInterval(this.timer);
this.entry = null;
document.getElementById('mainScreen').classList.add('hidden');
document.getElementById('loginScreen').classList.remove('hidden');
document.getElementById('pinInput').value = '';
}
}

showMainScreen(){
document.getElementById('loginScreen').classList.add('hidden');
document.getElementById('mainScreen').classList.remove('hidden');
document.getElementById('name').innerText = this.user.name;
}

loadHistory(){
// Load history for this specific user
const allHistory = JSON.parse(localStorage.getItem('allHistory') || '{}');
this.history = allHistory[this.user.name] || [];
}

saveHistory(){
// Save history for this specific user
const allHistory = JSON.parse(localStorage.getItem('allHistory') || '{}');
allHistory[this.user.name] = this.history;
localStorage.setItem('allHistory', JSON.stringify(allHistory));
}

/* CLOCK */
toggleClock(){
if(this.entry) this.clockOut();
else this.clockIn();
}

clockIn(){
this.entry = {start: new Date()};
document.getElementById('clockBtn').className = 'clock-out';
document.getElementById('clockText').innerHTML = '⏱️<br>Clock Out';
this.timer = setInterval(() => this.updateClock(), 1000);
}

clockOut(){
clearInterval(this.timer);
const end = new Date();
const notes = document.getElementById('notes').value;
const hours = ((end - this.entry.start) / 36e5);
const row = {
engineer: this.user.name,
date: end.toISOString().split('T')[0],
start: this.entry.start.toLocaleTimeString('en-GB'),
end: end.toLocaleTimeString('en-GB'),
hours: hours.toFixed(2),
notes: notes
};

// Save to history
this.history.push(row);
this.saveHistory();

// Send to Google Sheets
fetch(GOOGLE_SCRIPT_URL, {
method: 'POST',
mode: 'no-cors',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(row)
}).then(() => {
console.log('Sent to Google Sheets');
}).catch(err => {
console.log('Google Sheets error (but data saved locally):', err);
});

// Reset UI
this.entry = null;
document.getElementById('notes').value = '';
document.getElementById('today').innerText = '0:00';
document.getElementById('clockBtn').className = 'clock-in';
document.getElementById('clockText').innerHTML = '⏱️<br>Clock In';
this.render();
alert('✅ Clocked out! Hours: ' + row.hours);
}

/* LIVE CLOCK */
updateClock(){
const now = new Date();
const hrs = ((now - this.entry.start) / 36e5);
const h = Math.floor(hrs);
const m = Math.floor((hrs - h) * 60);
document.getElementById('today').innerText = 
`${h}:${m.toString().padStart(2,'0')}`;
}

/* TABLE */
toggleTable(){
const wrap = document.getElementById('tableWrap');
if(wrap.classList.contains('hidden')){
wrap.classList.remove('hidden');
this.render();
} else {
wrap.classList.add('hidden');
}
}

render(){
const tbody = document.getElementById('tbody');
tbody.innerHTML = '';
// Show most recent entries first
const recent = this.history.slice(-14).reverse();
recent.forEach((r, i) => {
const actualIndex = this.history.length - 1 - i;
tbody.innerHTML += `
<tr>
<td>${r.date}</td>
<td>
<input class="table-input"
value="${r.start}"
onchange="app.edit(${actualIndex},'start',this.value)">
</td>
<td>
<input class="table-input"
value="${r.end}"
onchange="app.edit(${actualIndex},'end',this.value)">
</td>
<td>${r.hours}</td>
<td>
<input class="table-input"
value="${r.notes || ''}"
onchange="app.edit(${actualIndex},'notes',this.value)">
</td>
</tr>`;
});
}

/* EDIT */
edit(i, field, val){
this.history[i][field] = val;
this.saveHistory();
}
}

const app = new Timesheet();

// Allow Enter key to login
document.addEventListener('DOMContentLoaded', function(){
const pinInput = document.getElementById('pinInput');
if(pinInput){
pinInput.addEventListener('keypress', function(e){
if(e.key === 'Enter'){
app.login();
}
});
}
});
</script>
</body>
</html>
