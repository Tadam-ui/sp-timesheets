<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SP Timesheets</title>
<style>
body{
font-family:Arial, sans-serif;
background:linear-gradient(135deg,#ff6b6b,#ff8787);
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
margin:0;
padding:20px;
}
.app{
background:white;
padding:30px;
border-radius:20px;
width:100%;
max-width:400px;
text-align:center;
box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.logo{
width:80px;
height:80px;
background:#dc3545;
border-radius:50%;
margin:0 auto 20px;
display:flex;
align-items:center;
justify-content:center;
font-size:36px;
font-weight:700;
color:white;
}
h2{
margin:10px 0 20px;
color:#2c3e50;
}
h3{
color:#2c3e50;
margin:10px 0;
}
/* LOGIN SCREEN */
.login-input{
width:100%;
padding:15px;
margin:10px 0;
border-radius:12px;
font-size:16px;
border:2px solid #e0e0e0;
box-sizing:border-box;
}
.login-input:focus{
outline:none;
border-color:#dc3545;
}
.login-btn, .primary-btn{
width:100%;
padding:15px;
background:#dc3545;
color:white;
border:none;
border-radius:12px;
font-size:16px;
font-weight:600;
cursor:pointer;
margin-top:10px;
}
.login-btn:hover, .primary-btn:hover{
background:#c82333;
}
.help-text{
color:#7f8c8d;
font-size:14px;
margin-top:15px;
}
/* MAIN APP */
button{
padding:12px 20px;
border:none;
border-radius:30px;
cursor:pointer;
margin:8px;
font-size:16px;
font-weight:600;
}
.clock-in{
background:#2ecc71;
color:white;
padding:40px;
width:180px;
height:180px;
border-radius:50%;
font-size:20px;
margin:20px auto;
display:flex;
align-items:center;
justify-content:center;
flex-direction:column;
}
.clock-out{
background:#e74c3c;
color:white;
padding:40px;
width:180px;
height:180px;
border-radius:50%;
font-size:20px;
margin:20px auto;
}
.logout-btn{
background:#6c757d;
color:white;
padding:8px 16px;
font-size:14px;
}
.secondary-btn{
background:#00bcd4;
color:white;
padding:12px 24px;
width:100%;
margin:5px 0;
}
.add-entry-btn{
background:#ffc107;
color:#2c3e50;
padding:12px 24px;
width:100%;
margin:5px 0;
}
textarea, input[type="date"], input[type="time"]{
width:100%;
padding:12px;
border:2px solid #e0e0e0;
border-radius:8px;
font-size:14px;
margin:10px 0;
font-family:Arial;
box-sizing:border-box;
}
table{
width:100%;
font-size:12px;
margin-top:15px;
border-collapse:collapse;
}
td,th{
border-bottom:1px solid #ddd;
padding:8px 4px;
text-align:left;
}
th{
background:#f5f5f5;
font-weight:600;
}
input.table-input{
width:100%;
font-size:11px;
padding:4px;
border:1px solid #ddd;
border-radius:4px;
}
.today-hours{
font-size:18px;
color:#2c3e50;
margin:15px 0;
font-weight:600;
}
.hidden{
display:none;
}
.error{
color:#e74c3c;
background:#ffe5e5;
padding:10px;
border-radius:8px;
margin:10px 0;
font-size:14px;
}
.success{
color:#2ecc71;
background:#e8f5e9;
padding:10px;
border-radius:8px;
margin:10px 0;
font-size:14px;
}
.form-group{
margin:15px 0;
text-align:left;
}
.form-group label{
display:block;
font-weight:600;
margin-bottom:5px;
color:#2c3e50;
font-size:14px;
}
.btn-group{
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
margin-top:15px;
}
.cancel-btn{
background:#6c757d;
color:white;
}
</style>
</head>
<body>
<div class="app">
<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
<div class="logo">SP</div>
<h2>SP Timesheets</h2>
<p class="help-text">Enter your 4-digit PIN</p>
<input type="tel" 
       id="pinInput" 
       class="login-input" 
       placeholder="Enter PIN (e.g., 1234)" 
       maxlength="4"
       pattern="[0-9]*"
       inputmode="numeric">
<button class="login-btn" onclick="app.login()">Login</button>
<div id="errorMsg" class="error hidden"></div>
<p class="help-text" style="margin-top:25px;">Enter your personal 4-digit PIN to access your timesheet.</p>
</div>

<!-- MAIN APP SCREEN -->
<div id="mainScreen" class="hidden">
<div class="logo">SP</div>
<h2>SP Timesheets</h2>
<h3 id="name"></h3>
<button class="logout-btn" onclick="app.logout()">Logout</button>
<p class="today-hours">Today: <span id="today">0:00</span></p>
<button id="clockBtn" class="clock-in" onclick="app.toggleClock()">
<span id="clockText">‚è±Ô∏è<br>Clock In</span>
</button>
<textarea id="notes" placeholder="Job notes (e.g., ¬£250 bonus, night work, etc.)"></textarea>
<button class="secondary-btn" onclick="app.showTimesheet()">üìÖ View My Timesheet</button>
<button class="add-entry-btn" onclick="app.showAddEntry()">‚ûï Add Past Entry</button>
</div>

<!-- TIMESHEET VIEW -->
<div id="timesheetScreen" class="hidden">
<h2>My Timesheet</h2>
<h3 id="timesheetName"></h3>
<button class="logout-btn" onclick="app.showMain()">‚Üê Back</button>
<div id="tableWrap" style="margin-top:20px;">
<table>
<thead>
<tr>
<th>Date</th>
<th>Start</th>
<th>End</th>
<th>Hrs</th>
<th>Notes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- ADD ENTRY SCREEN -->
<div id="addEntryScreen" class="hidden">
<h2>Add Past Entry</h2>
<h3 id="addEntryName"></h3>
<button class="logout-btn" onclick="app.showMain()">‚Üê Back</button>

<div class="form-group">
<label>Date:</label>
<input type="date" id="entryDate" max="">
</div>

<div class="form-group">
<label>Clock In Time:</label>
<input type="time" id="entryStartTime">
</div>

<div class="form-group">
<label>Clock Out Time:</label>
<input type="time" id="entryEndTime">
</div>

<div class="form-group">
<label>Notes:</label>
<textarea id="entryNotes" placeholder="e.g., ¬£250 bonus, night work" style="height:80px;"></textarea>
</div>

<div id="addEntryMsg" class="hidden"></div>

<div class="btn-group">
<button class="cancel-btn" onclick="app.showMain()">Cancel</button>
<button class="primary-btn" onclick="app.saveManualEntry()">Save Entry</button>
</div>
</div>

</div>

<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvRWVHRf_diTDdZ8qp_RPXj4n97SZNb5ePPuALqdBWgH0L1KOxN3UzoYif2Ly5eiOy-Q/exec';

// EMPLOYEE DATABASE WITH PINS
const EMPLOYEES = {
'1234': { name: 'Dan Halpin', pin: '1234' },
'5678': { name: 'Paul Read', pin: '5678' },
'9012': { name: 'Devris Hudaverdi', pin: '9012' },
'3456': { name: 'Shane Clark', pin: '3456' },
'7890': { name: 'Jack Saillart', pin: '7890' },
'2468': { name: 'John Tomlin', pin: '2468' }
};

class Timesheet{
constructor(){
this.user = null;
this.entry = null;
this.timer = null;
this.history = [];
// Check if user is already logged in
const savedUser = localStorage.getItem('currentUser');
if(savedUser){
this.user = JSON.parse(savedUser);
this.loadHistory();
this.showMainScreen();
}
}

/* LOGIN WITH PIN */
login(){
const pin = document.getElementById('pinInput').value.trim();
const errorMsg = document.getElementById('errorMsg');

if(!pin || pin.length !== 4){
errorMsg.textContent = '‚ö†Ô∏è Please enter a 4-digit PIN';
errorMsg.classList.remove('hidden');
return;
}

const employee = EMPLOYEES[pin];
if(!employee){
errorMsg.textContent = '‚ùå Invalid PIN. Please try again.';
errorMsg.classList.remove('hidden');
document.getElementById('pinInput').value = '';
return;
}

this.user = employee;
localStorage.setItem('currentUser', JSON.stringify(this.user));
this.loadHistory();
this.showMainScreen();
errorMsg.classList.add('hidden');
document.getElementById('pinInput').value = '';
}

logout(){
if(confirm('Are you sure you want to logout?')){
localStorage.removeItem('currentUser');
this.user = null;
this.history = [];
if(this.timer) clearInterval(this.timer);
this.entry = null;
this.hideAllScreens();
document.getElementById('loginScreen').classList.remove('hidden');
document.getElementById('pinInput').value = '';
}
}

hideAllScreens(){
document.getElementById('loginScreen').classList.add('hidden');
document.getElementById('mainScreen').classList.add('hidden');
document.getElementById('timesheetScreen').classList.add('hidden');
document.getElementById('addEntryScreen').classList.add('hidden');
}

showMainScreen(){
this.hideAllScreens();
document.getElementById('mainScreen').classList.remove('hidden');
document.getElementById('name').innerText = this.user.name;
this.updateTodayHours();
}

showMain(){
this.showMainScreen();
}

showTimesheet(){
this.hideAllScreens();
document.getElementById('timesheetScreen').classList.remove('hidden');
document.getElementById('timesheetName').innerText = this.user.name;
this.renderTimesheet();
}

showAddEntry(){
this.hideAllScreens();
document.getElementById('addEntryScreen').classList.remove('hidden');
document.getElementById('addEntryName').innerText = this.user.name;
// Set max date to today
const today = new Date().toISOString().split('T')[0];
document.getElementById('entryDate').max = today;
document.getElementById('entryDate').value = today;
// Clear form
document.getElementById('entryStartTime').value = '';
document.getElementById('entryEndTime').value = '';
document.getElementById('entryNotes').value = '';
document.getElementById('addEntryMsg').classList.add('hidden');
}

loadHistory(){
const allHistory = JSON.parse(localStorage.getItem('allHistory') || '{}');
this.history = allHistory[this.user.name] || [];
}

saveHistory(){
const allHistory = JSON.parse(localStorage.getItem('allHistory') || '{}');
allHistory[this.user.name] = this.history;
localStorage.setItem('allHistory', JSON.stringify(allHistory));
}

/* CLOCK IN/OUT (TODAY ONLY) */
toggleClock(){
if(this.entry) this.clockOut();
else this.clockIn();
}

clockIn(){
this.entry = {start: new Date()};
document.getElementById('clockBtn').className = 'clock-out';
document.getElementById('clockText').innerHTML = '‚è±Ô∏è<br>Clock Out';
this.timer = setInterval(() => this.updateClock(), 1000);
}

clockOut(){
clearInterval(this.timer);
const end = new Date();
const notes = document.getElementById('notes').value;
const hours = ((end - this.entry.start) / 36e5);
const row = {
engineer: this.user.name,
date: end.toISOString().split('T')[0],
start: this.entry.start.toLocaleTimeString('en-GB'),
end: end.toLocaleTimeString('en-GB'),
hours: hours.toFixed(2),
notes: notes
};

this.history.push(row);
this.saveHistory();
this.sendToGoogleSheets(row);

this.entry = null;
document.getElementById('notes').value = '';
document.getElementById('today').innerText = '0:00';
document.getElementById('clockBtn').className = 'clock-in';
document.getElementById('clockText').innerHTML = '‚è±Ô∏è<br>Clock In';
alert('‚úÖ Clocked out! Hours: ' + row.hours);
}

/* MANUAL ENTRY (ANY PAST DATE) */
saveManualEntry(){
const date = document.getElementById('entryDate').value;
const startTime = document.getElementById('entryStartTime').value;
const endTime = document.getElementById('entryEndTime').value;
const notes = document.getElementById('entryNotes').value;
const msgDiv = document.getElementById('addEntryMsg');

// Validation
if(!date || !startTime || !endTime){
msgDiv.textContent = '‚ö†Ô∏è Please fill in date, start time, and end time';
msgDiv.className = 'error';
msgDiv.classList.remove('hidden');
return;
}

// Calculate hours
const start = new Date(`${date}T${startTime}`);
const end = new Date(`${date}T${endTime}`);
const hours = ((end - start) / 36e5);

if(hours <= 0){
msgDiv.textContent = '‚ö†Ô∏è End time must be after start time';
msgDiv.className = 'error';
msgDiv.classList.remove('hidden');
return;
}

const row = {
engineer: this.user.name,
date: date,
start: startTime,
end: endTime,
hours: hours.toFixed(2),
notes: notes
};

this.history.push(row);
this.saveHistory();
this.sendToGoogleSheets(row);

msgDiv.textContent = '‚úÖ Entry saved successfully!';
msgDiv.className = 'success';
msgDiv.classList.remove('hidden');

setTimeout(() => {
this.showTimesheet();
}, 1500);
}

sendToGoogleSheets(row){
fetch(GOOGLE_SCRIPT_URL, {
method: 'POST',
mode: 'no-cors',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(row)
}).then(() => {
console.log('Sent to Google Sheets');
}).catch(err => {
console.log('Google Sheets error (but data saved locally):', err);
});
}

/* LIVE CLOCK */
updateClock(){
const now = new Date();
const hrs = ((now - this.entry.start) / 36e5);
const h = Math.floor(hrs);
const m = Math.floor((hrs - h) * 60);
document.getElementById('today').innerText = 
`${h}:${m.toString().padStart(2,'0')}`;
}

updateTodayHours(){
const today = new Date().toISOString().split('T')[0];
const todayEntries = this.history.filter(e => e.date === today);
const totalHours = todayEntries.reduce((sum, e) => sum + parseFloat(e.hours || 0), 0);
const h = Math.floor(totalHours);
const m = Math.round((totalHours - h) * 60);
document.getElementById('today').innerText = `${h}:${m.toString().padStart(2,'0')}`;
}

/* TIMESHEET VIEW */
renderTimesheet(){
const tbody = document.getElementById('tbody');
tbody.innerHTML = '';
// Sort by date (newest first)
const sorted = [...this.history].sort((a,b) => new Date(b.date) - new Date(a.date));
const recent = sorted.slice(0, 30); // Show last 30 entries

recent.forEach((r, i) => {
const actualIndex = this.history.findIndex(e => 
e.date === r.date && e.start === r.start && e.end === r.end
);
tbody.innerHTML += `
<tr>
<td>${r.date}</td>
<td>
<input class="table-input"
value="${r.start}"
onchange="app.edit(${actualIndex},'start',this.value)">
</td>
<td>
<input class="table-input"
value="${r.end}"
onchange="app.edit(${actualIndex},'end',this.value)">
</td>
<td>${r.hours}</td>
<td>
<input class="table-input"
value="${r.notes || ''}"
onchange="app.edit(${actualIndex},'notes',this.value)">
</td>
</tr>`;
});

if(recent.length === 0){
tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#7f8c8d;">No entries yet</td></tr>';
}
}

/* EDIT */
edit(i, field, val){
this.history[i][field] = val;
this.saveHistory();
}
}

const app = new Timesheet();

// Allow Enter key to login
document.addEventListener('DOMContentLoaded', function(){
const pinInput = document.getElementById('pinInput');
if(pinInput){
pinInput.addEventListener('keypress', function(e){
if(e.key === 'Enter'){
app.login();
}
});
}
});
</script>
</body>
</html>
